openapi: 3.0.0
info:
  title: Todo Chat API
  description: AI-powered conversational interface for todo management
  version: 1.0.0
  contact:
    name: Todo App Team

servers:
  - url: http://localhost:8000
    description: Development server
  - url: https://api.todo-app.com
    description: Production server

paths:
  /api/{user_id}/chat:
    post:
      summary: Send chat message and receive AI response
      description: |
        Stateless chat endpoint that processes natural language messages and returns AI responses.
        The endpoint handles conversation history retrieval, agent execution, and message storage.
      operationId: sendChatMessage
      tags:
        - Chat
      security:
        - BearerAuth: []
      parameters:
        - name: user_id
          in: path
          required: true
          description: User identifier (must match JWT token)
          schema:
            type: string
            example: "user_123"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - message
              properties:
                conversation_id:
                  type: integer
                  description: Existing conversation ID (optional, creates new if not provided)
                  example: 42
                message:
                  type: string
                  description: User's natural language message
                  minLength: 1
                  maxLength: 2000
                  example: "Add a task to buy groceries"
            examples:
              newConversation:
                summary: Start new conversation
                value:
                  message: "Show me all my tasks"
              existingConversation:
                summary: Continue existing conversation
                value:
                  conversation_id: 42
                  message: "Mark the first one as done"
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                required:
                  - conversation_id
                  - response
                  - tool_calls
                properties:
                  conversation_id:
                    type: integer
                    description: The conversation ID (new or existing)
                    example: 42
                  response:
                    type: string
                    description: AI assistant's natural language response
                    example: "I've created the task 'Buy groceries' for you. Your task ID is 5."
                  tool_calls:
                    type: array
                    description: List of MCP tools invoked during processing
                    items:
                      type: object
                      required:
                        - tool
                        - parameters
                        - result
                      properties:
                        tool:
                          type: string
                          description: Name of the MCP tool invoked
                          example: "add_task"
                        parameters:
                          type: object
                          description: Parameters passed to the tool
                          example:
                            user_id: "user_123"
                            title: "Buy groceries"
                        result:
                          type: object
                          description: Result returned by the tool
                          example:
                            task_id: 5
                            status: "created"
                            title: "Buy groceries"
              examples:
                taskCreation:
                  summary: Task creation response
                  value:
                    conversation_id: 42
                    response: "I've created the task 'Buy groceries' for you. Your task ID is 5."
                    tool_calls:
                      - tool: "add_task"
                        parameters:
                          user_id: "user_123"
                          title: "Buy groceries"
                        result:
                          task_id: 5
                          status: "created"
                          title: "Buy groceries"
                taskListing:
                  summary: Task listing response
                  value:
                    conversation_id: 42
                    response: "You have 3 pending tasks: 1) Buy groceries, 2) Call mom, 3) Pay bills"
                    tool_calls:
                      - tool: "list_tasks"
                        parameters:
                          user_id: "user_123"
                          status: "pending"
                        result:
                          - id: 1
                            title: "Buy groceries"
                            completed: false
                          - id: 2
                            title: "Call mom"
                            completed: false
                          - id: 3
                            title: "Pay bills"
                            completed: false
        '400':
          description: Bad request (invalid message or parameters)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                emptyMessage:
                  summary: Empty message
                  value:
                    error: "Bad Request"
                    message: "Message cannot be empty"
                    status_code: 400
                messageTooLong:
                  summary: Message too long
                  value:
                    error: "Bad Request"
                    message: "Message exceeds maximum length of 2000 characters"
                    status_code: 400
        '401':
          description: Unauthorized (invalid or missing JWT token)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missingToken:
                  summary: Missing JWT token
                  value:
                    error: "Unauthorized"
                    message: "Authentication required"
                    status_code: 401
                invalidToken:
                  summary: Invalid JWT token
                  value:
                    error: "Unauthorized"
                    message: "Invalid authentication token"
                    status_code: 401
                userIdMismatch:
                  summary: User ID mismatch
                  value:
                    error: "Unauthorized"
                    message: "User ID in path does not match authenticated user"
                    status_code: 401
        '404':
          description: Conversation not found or unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                conversationNotFound:
                  summary: Conversation not found
                  value:
                    error: "Not Found"
                    message: "Conversation with ID 999 not found or you don't have access"
                    status_code: 404
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                databaseError:
                  summary: Database error
                  value:
                    error: "Internal Server Error"
                    message: "An unexpected error occurred. Please try again."
                    status_code: 500
                agentError:
                  summary: Agent execution error
                  value:
                    error: "Internal Server Error"
                    message: "Failed to process message. Please try again."
                    status_code: 500

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token from Better Auth authentication

  schemas:
    Error:
      type: object
      required:
        - error
        - message
        - status_code
      properties:
        error:
          type: string
          description: Error type
          example: "Bad Request"
        message:
          type: string
          description: Human-readable error message
          example: "Message cannot be empty"
        status_code:
          type: integer
          description: HTTP status code
          example: 400
        details:
          type: object
          description: Additional error details (optional)
          additionalProperties: true

tags:
  - name: Chat
    description: Conversational AI interface for todo management
